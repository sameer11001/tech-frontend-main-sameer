<!-- only show the normal toolbar & previews when NOT expired -->
<ng-container *ngIf="!isExpired">
  <!-- Toolbar + Text Input (shown only when NOT previewing) -->
  <div *ngIf="!previewData.type" class="flex bg-white border-t p-4 items-center space-x-2">
  <!-- File Attachment -->
  <label class="cursor-pointer text-gray-600 hover:text-gray-800">
    ğŸ“
    <input type="file" class="hidden" (change)="onFileSelected($event)" />
  </label>

  <!-- Send Location -->
  <button (click)="sendLocation()" class="text-gray-600 hover:text-gray-800">
    ğŸ“
  </button>

  <!-- Send Template -->
  <button
    (click)="openTemplatePicker()"
    class="text-gray-600 hover:text-gray-800"
  >
    ğŸ“„
  </button>

  <!-- Text Input -->
  <input
    type="text"
    class="border w-full rounded-full px-4 py-2 focus:outline-none"
    placeholder="Type a message..."
    [(ngModel)]="messageBody"
    (keyup.enter)="sendText()"
  />

  <!-- Send Button -->
  <button
    (click)="sendText()"
    [disabled]="!messageBody.trim()"
    class="ml-2 bg-blue-500 text-white rounded-full px-4 py-2 justify-end items-end disabled:opacity-50"
  >
    â¤
  </button>
</div>

<!-- Media Preview -->
<div
  *ngIf="previewData.type === 'document' || previewData.type === 'image' || previewData.type === 'video'"
  class="border-t border-gray-200 p-4 bg-gray-50 space-y-3"
>
  <div class="flex items-center space-x-3">
    <img
      [src]="getFilePreview(previewData.file!)"
      alt="Preview"
      class="w-16 h-16 object-cover rounded"
    />
    <input
      type="text"
      [(ngModel)]="previewData.caption"
      placeholder="Add captionâ€¦"
      class="flex-1 px-3 py-2 border rounded-md text-sm"
    />
  </div>
  <div class="flex space-x-2">
    <button
      (click)="submitPreview()"
      class="px-4 py-2 bg-blue-500 text-white rounded-md text-sm"
    >
      Send Media
    </button>
    <button
      (click)="cancelPreview()"
      class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md text-sm"
    >
      Cancel
    </button>
  </div>
</div>

<!-- Location Preview -->
<div
  *ngIf="previewData.type === 'location'"
  class="border-t border-gray-200 p-4 bg-gray-50 space-y-3"
>
  <div class="flex items-center space-x-3">
    <div class="w-16 h-16 bg-blue-100 rounded flex items-center justify-center">
      ğŸ“
    </div>
    <div class="flex-1 space-y-2">
      <input
        type="text"
        [(ngModel)]="previewData.name"
        placeholder="Location name (optional)"
        class="w-full px-3 py-2 border rounded-md text-sm"
      />
      <input
        type="text"
        [(ngModel)]="previewData.address"
        placeholder="Address (optional)"
        class="w-full px-3 py-2 border rounded-md text-sm"
      />
    </div>
  </div>
  <div class="text-xs text-gray-500">
    Coordinates: {{ previewData.latitude }}, {{ previewData.longitude }}
  </div>
  <div class="flex space-x-2">
    <button
      (click)="submitPreview()"
      class="px-4 py-2 bg-blue-500 text-white rounded-md text-sm"
    >
      Send Location
    </button>
    <button
      (click)="cancelPreview()"
      class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md text-sm"
    >
      Cancel
    </button>
  </div>
</div>
</ng-container>

<!-- EXPIRED BAR -->
<div
  *ngIf="isExpired"
  class="flex bg-yellow-100 border-t p-4 items-center space-x-2 text-gray-700 text-sm"
>
  <span>You can only send a template when the chat has expired</span>
  <button
    (click)="openTemplatePicker()"
    class="ml-auto bg-blue-500 text-white rounded-full px-4 py-2"
  >
    Send template
  </button>
</div>

<!-- TEMPLATE PICKER OVERLAY -->
<div
  *ngIf="showTemplatePicker"
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4"
>
  <div class="bg-white rounded-lg max-w-xl w-full p-6 space-y-4">
    <h3 class="text-lg font-semibold">Select a Template</h3>
    <div *ngIf="loading$ | async" class="text-center py-4">Loadingâ€¦</div>
    <ng-container *ngIf="!(loading$ | async)">
      <ul class="max-h-64 overflow-auto space-y-2">
        <ng-container
          *ngFor="let template of templates$ | async; let i = index"
        >
          <li
            (click)="chooseTemplate(template)"
            [class.bg-blue-100]="template === selectedTemplate"
            class="p-3 rounded cursor-pointer hover:bg-gray-100"
          >
            {{template.name}}      -      {{template.language}}
          </li>
        </ng-container>
      </ul>
    </ng-container>

    <!-- ACTIONS -->
    <div class="text-right space-x-2 pt-4">
      <button
        (click)="sendTemplate()"
        [disabled]="!selectedTemplate"
        class="px-4 py-2 bg-blue-500 text-white rounded disabled:opacity-50"
      >
        Send
      </button>
      <button
        (click)="cancelTemplate()"
        class="px-4 py-2 bg-gray-300 text-gray-700 rounded"
      >
        Cancel
      </button>
    </div>
  </div>
</div>
